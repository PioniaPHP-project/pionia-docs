<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="preload" href="http://localhost:1313/fonts/vendor/jost/jost-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:1313/fonts/vendor/jost/jost-v4-latin-500.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="http://localhost:1313/fonts/vendor/jost/jost-v4-latin-700.woff2" as="font" type="font/woff2" crossorigin>
<script 
  src="/js/color-mode.f14b3e296de1d0b69e75af684b62a4a912a2cadab04e36123407cd8388204f1d.js"
  integrity="sha256-8Us&#43;KW3h0Laeda9oS2KkqRKiytqwTjYSNAfNg4ggTx0=">
</script>


<link rel="stylesheet" href="/main.01b0834d5af51b24812d02878d09c8d7677d6b8af13164fb50215889dc19aaefd0e9366c13b45a9a57ae481dfd1836bce46b5ebfe461d56e3498b9443d8c5e27.css" integrity="sha512-AbCDTVr1GySBLQKHjQnI12d9a4rxMWT7UCFYidwZqu/Q6TZsE7RamleuSB39GDa85Gtev&#43;Rh1W40mLlEPYxeJw==" crossorigin="anonymous">

<noscript><style>img.lazyload { display: none; }</style></noscript><base href="http://localhost:1313/documentation/jwt-authentication/">
  <link rel="canonical" href="http://localhost:1313/documentation/jwt-authentication/">
<title>JWT Authentication </title>
<meta name="description" content="Guides us through Pionia&#39;s approach to authentication using JWT.">

    
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    
      <link rel="icon" href="/favicon.svg" type="image/png">
    
      <link
        rel="apple-touch-icon"
        href="/apple-touch-icon.png"
        sizes="180x180"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-192x192.png"
        sizes="192x192"
        type="image/png"
      >
      <link
        rel="icon"
        href="/favicon-512x512.png"
        sizes="512x512"
        type="image/png"
      >
<link rel="manifest" href="/manifest.webmanifest">
<meta property="og:title" content="JWT Authentication">
<meta property="og:description" content="Guides us through Pionia&#39;s approach to authentication using JWT.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:1313/documentation/jwt-authentication/"><meta property="og:image" content="http://localhost:1313/pionia.png"><meta property="article:section" content="docs">
<meta property="article:published_time" content="2024-06-29T21:06:45+03:00">
<meta property="article:modified_time" content="2024-05-24T13:45:48+00:00"><meta property="og:site_name" content="Pionia Framework">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/pionia.png"><meta name="twitter:title" content="JWT Authentication">
<meta name="twitter:description" content="Guides us through Pionia&#39;s approach to authentication using JWT.">
<meta name="twitter:site" content="@pionia">

    
    
    <script type="application/ld+json">
  {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/",
       "name": "Pionia Framework",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/docs/",
       "name": "Docs",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/docs/documentation/",
       "name": "Documentation",
       "position": 3
     },
     {
       "@type": "ListItem",
       "name": "JWT Authentication",
       "position": 4
     }
   ]
 }
</script>





</head>

  
  <body class="single section docs" data-bs-spy="scroll" data-bs-target="#toc" data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll="true" tabindex="0">
    <div class="sticky-top">
<div class="header-bar"></div>
<header class="navbar navbar-expand-lg">
  <div class="container-sm">
  
    <a class="navbar-brand me-auto me-lg-3" href="/">Pionia</a>

    
    
    <button type="button" id="searchToggleMobile" class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <circle cx="10" cy="10" r="7"></circle>
        <line x1="21" y1="21" x2="15" y2="15"></line>
      </svg>
    </button>
    
    <button class="btn btn-link d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavSection" aria-controls="offcanvasNavSection" aria-label="Open section navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-dots-vertical" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
        <path d="M12 5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
      </svg>
    </button>
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="offcanvasNavSection" aria-labelledby="offcanvasNavSectionLabel">
      <div class="header-bar"></div>
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavSectionLabel">Docs</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="offcanvas-body">
        <aside class="doks-sidebar mt-n3">
          <nav id="doks-docs-nav" aria-label="Tertiary navigation">
            
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Documentation</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/documentation/introduction/">Introduction</a>
  </li>

  <li>
      <a href="/documentation/why-pionia/">Why Pionia?</a>
  </li>

  <li>
      <a href="/documentation/application-structure/">Application Structure</a>
  </li>

  <li>
      <a href="/documentation/api-tutorial/">API Tutorial</a>
  </li>

  <li>
      <a href="/documentation/services/">Services</a>
  </li>

  <li>
      <a href="/documentation/generic-services/">Generic Services</a>
  </li>

  <li>
      <a href="/documentation/security-authentication-and-authorization/">Security - Authentication and Authorization</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/documentation/jwt-authentication/">JWT Authentication</a>
  </li>

  <li>
      <a href="/documentation/logging-in-pionia/">Logging in Pionia</a>
  </li>

  <li>
    <details open>
      <summary>Database</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/documentation/database/configuration-getting-started/">Configuration - Getting Started</a>
  </li>

  <li>
      <a href="/documentation/database/making-queries/">Making Queries</a>
  </li>

  <li>
      <a href="/documentation/database/queries-with-filtering/">Queries with Filtering</a>
  </li>

  <li>
      <a href="/documentation/database/using-functions-aggregation/">Using Functions - Aggregation</a>
  </li>
      </ul>
    </details>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Moonlight Architecture</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/moonlight/introduction-to-moonlight-architecture/">Introduction to MoonLight Architecture</a>
  </li>

  <li>
      <a href="/moonlight/security-in-moonlight/">Security in moonlight</a>
  </li>

  <li>
      <a href="/moonlight/api-versioning-in-moonlight/">API Versioning in Moonlight</a>
  </li>
      </ul>
    </details>
  </li>
  </ul>
</nav>

  

          </nav>
        </aside>
      </div>
    </div>
    
    <button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavMain" aria-controls="offcanvasNavMain" aria-label="Open main navigation menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <line x1="4" y1="8" x2="20" y2="8"></line>
        <line x1="4" y1="16" x2="20" y2="16"></line>
      </svg>
    </button>

    
    <div class="offcanvas offcanvas-end h-auto" tabindex="-1" id="offcanvasNavMain" aria-labelledby="offcanvasNavMainLabel">
      <div class="header-bar d-lg-none"></div>
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavMainLabel">Pionia</h5>
        <button type="button" class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss="offcanvas" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M18 6l-12 12"></path>
            <path d="M6 6l12 12"></path>
         </svg>
        </button>
      </div>
      
      <div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between">
        <ul class="navbar-nav flex-grow-1"><li class="nav-item">
                <a class="nav-link" href="http://localhost:1313/documentation/introduction/">Documentation</a>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="http://localhost:1313/moonlight/introduction-to-moonlight-architecture/">Moonlight</a>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="http://localhost:1313/documentation/api-tutorial/">Tutorial</a>
              </li>
            </ul>

        
        
        <button type="button" id="searchToggleDesktop" class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <circle cx="10" cy="10" r="7"></circle>
            <line x1="21" y1="21" x2="15" y2="15"></line>
          </svg>
        </button>
        
        
        
        <button id="buttonColorMode" class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type="button" aria-label="Toggle theme">
          <svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
          </svg>
          <svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0m-5 0h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7"></path>
          </svg>
        </button>
        
        <ul id="socialMenu" class="nav mx-auto flex-row order-lg-4">
          <li class="nav-item">
              <a class="nav-link social-link" href="https://github.com/PioniaPHP-project/pionia-docs"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path></svg><small class="ms-2 visually-hidden">GitHub</small></a>
            </li>
          </ul>
        
        <a class="btn btn-primary rounded-pill mt-2 btn-block d-lg-none" href="http://localhost:1313/documentation/introduction/#get-started" role="button">Get started</a>
        </div>
    </div>

    
    <a class="btn btn-primary rounded-pill ms-3 me-2 px-4 order-lg-3 d-none d-lg-block" href="http://localhost:1313/documentation/introduction/#get-started" role="button">Get started</a>
    </div>
</header>
</div>

<div class="modal" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 visually-hidden" id="searchModalLabel">Search</h1>
        <button type="button" class="btn-close visually-hidden" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="search-input flex-grow-1 d-none">
          <form id="search-form" class="search-form" action="#" method="post" accept-charset="UTF-8" role="search">
            <label for="query" class="visually-hidden">Search</label>
            <div class="d-flex">
              <input type="search" id="query" name="query" class="search-text form-control form-control-lg" placeholder="Search" aria-label="Search" maxlength="128" autocomplete="off">
              <button type="button" class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-body">
        <p class="search-loading status message d-none mt-3 text-center">Loading search index…</p>
        <p class="search-no-recent message d-none mt-3 text-center">No recent searches</p>
        <p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class="query-no-results">Query here</span></strong>"</p>
        <div id="searchResults" class="search-results"></div>
        <template>
          <article class="search-result list-view">
            <div class="card my-3">
              <div class="card-body">
                <header>
                  <h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href="#">Title here</a></h2>
                  <div class="submitted"><time class="created-date">Date here</time></div>
                </header>
                <div class="content">Summary here</div>
              </div>
            </div>
          </article>
        </template>
      </div>
      <div class="modal-footer">
        <ul class="list-inline me-auto d-none d-md-block">
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4M7 11.53088l-3-3 3-3"></path></g></svg></kbd><span class="DocSearch-Label">to select</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8M10.5 8.5l-3 3-3-3"></path></g></svg></kbd><kbd class="me-2"><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8M10.5 6.5l-3-3-3 3"></path></g></svg></kbd><span class="DocSearch-Label">to navigate</span></li>
          <li class="list-inline-item"><kbd class="me-2"><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956"></path></g></svg></kbd><span class="DocSearch-Label">to close</span></li>
        </ul>
        <p class="d-md-none">Search by <a class="text-decoration-none" href="https://github.com/nextapps-de/flexsearch">FlexSearch</a></p>
      </div>
    </div>
  </div>
</div>


    <div class="wrap container-sm" role="document">
      <div class="content">
      
        
	<div class="row flex-xl-nowrap">
		<div class="col-lg-5 col-xl-4 docs-sidebar docs-sidebar-offset d-none d-lg-block">
			
  
    
<nav class="section-nav docs-links">
  <ul class="list-unstyled">

  <li>
    <details open open>
      <summary>Documentation</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/documentation/introduction/">Introduction</a>
  </li>

  <li>
      <a href="/documentation/why-pionia/">Why Pionia?</a>
  </li>

  <li>
      <a href="/documentation/application-structure/">Application Structure</a>
  </li>

  <li>
      <a href="/documentation/api-tutorial/">API Tutorial</a>
  </li>

  <li>
      <a href="/documentation/services/">Services</a>
  </li>

  <li>
      <a href="/documentation/generic-services/">Generic Services</a>
  </li>

  <li>
      <a href="/documentation/security-authentication-and-authorization/">Security - Authentication and Authorization</a>
  </li>

  <li class="active" >
      <a aria-current="page" href="/documentation/jwt-authentication/">JWT Authentication</a>
  </li>

  <li>
      <a href="/documentation/logging-in-pionia/">Logging in Pionia</a>
  </li>

  <li>
    <details open>
      <summary>Database</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/documentation/database/configuration-getting-started/">Configuration - Getting Started</a>
  </li>

  <li>
      <a href="/documentation/database/making-queries/">Making Queries</a>
  </li>

  <li>
      <a href="/documentation/database/queries-with-filtering/">Queries with Filtering</a>
  </li>

  <li>
      <a href="/documentation/database/using-functions-aggregation/">Using Functions - Aggregation</a>
  </li>
      </ul>
    </details>
  </li>
      </ul>
    </details>
  </li>

  <li>
    <details open>
      <summary>Moonlight Architecture</summary>
      <ul class="list-unstyled list-nested">

  <li>
      <a href="/moonlight/introduction-to-moonlight-architecture/">Introduction to MoonLight Architecture</a>
  </li>

  <li>
      <a href="/moonlight/security-in-moonlight/">Security in moonlight</a>
  </li>

  <li>
      <a href="/moonlight/api-versioning-in-moonlight/">API Versioning in Moonlight</a>
  </li>
      </ul>
    </details>
  </li>
  </ul>
</nav>

  

		</div>
		
		<nav class="docs-toc docs-toc-offset d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
			<div class="page-links">
  <h3>On this page</h3>
    <nav id="toc">
  <ul>
    <li><a href="#our-target">Our target</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#bootstrapping-our-authentication-backend">Bootstrapping our Authentication Backend</a>
      <ul>
        <li><a href="#what-do-we-have-here">What do we have here?</a></li>
        <li><a href="#what-do-we-have-here-1">What do we have here?</a></li>
      </ul>
    </li>
    <li><a href="#add-our-login-logic">Add our Login Logic</a>
      <ul>
        <li><a href="#what-do-we-have-here-2">What do we have here?</a></li>
        <li><a href="#registering-our-userservice">Registering our UserService</a></li>
      </ul>
    </li>
    <li><a href="#testing-our-authentication">Testing our Authentication</a>
      <ul>
        <li><a href="#registering-a-user">Registering a User</a></li>
        <li><a href="#register-user---response">Register User - Response</a></li>
        <li><a href="#logging-in-a-user">Logging in a User</a></li>
        <li><a href="#login-user---response">Login User - Response</a></li>
        <li><a href="#testing-authentication">Testing Authentication</a></li>
        <li><a href="#testing-the-profile-action---request-without-token">Testing the Profile Action - request without token</a></li>
        <li><a href="#response---not-token">Response - not token</a></li>
        <li><a href="#testing-the-profile-action---request-with-token">Testing the Profile Action - request with token</a></li>
        <li><a href="#testing-the-profile-action---request-with-token-1">Testing the Profile Action - request with token</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</div>

		</nav>
		<main class="docs-content col-lg-11 col-xl-9">
		
			<h1>JWT Authentication</h1>
			
			<nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation">
				<details>
    <summary>On this page</summary>
    <div class="page-links">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#our-target">Our target</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#requirements">Requirements</a></li>
    <li><a href="#bootstrapping-our-authentication-backend">Bootstrapping our Authentication Backend</a>
      <ul>
        <li><a href="#what-do-we-have-here">What do we have here?</a></li>
        <li><a href="#what-do-we-have-here-1">What do we have here?</a></li>
      </ul>
    </li>
    <li><a href="#add-our-login-logic">Add our Login Logic</a>
      <ul>
        <li><a href="#what-do-we-have-here-2">What do we have here?</a></li>
        <li><a href="#registering-our-userservice">Registering our UserService</a></li>
      </ul>
    </li>
    <li><a href="#testing-our-authentication">Testing our Authentication</a>
      <ul>
        <li><a href="#registering-a-user">Registering a User</a></li>
        <li><a href="#register-user---response">Register User - Response</a></li>
        <li><a href="#logging-in-a-user">Logging in a User</a></li>
        <li><a href="#login-user---response">Login User - Response</a></li>
        <li><a href="#testing-authentication">Testing Authentication</a></li>
        <li><a href="#testing-the-profile-action---request-without-token">Testing the Profile Action - request without token</a></li>
        <li><a href="#response---not-token">Response - not token</a></li>
        <li><a href="#testing-the-profile-action---request-with-token">Testing the Profile Action - request with token</a></li>
        <li><a href="#testing-the-profile-action---request-with-token-1">Testing the Profile Action - request with token</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
  </details>

			</nav>
			
<picture>
      <source type="image/webp" data-srcset="/pionia_hu7bc625304583a71a69e31d56c05815e9_99619_480x0_resize_q85_h2_lanczos_3.webp 480w,/pionia_hu7bc625304583a71a69e31d56c05815e9_99619_576x0_resize_q85_h2_lanczos_3.webp 576w,/pionia_hu7bc625304583a71a69e31d56c05815e9_99619_602x0_resize_q85_h2_lanczos_3.webp 602w"
        data-sizes="auto">
  <img
    src="data:image/webp;base64,UklGRrgAAABXRUJQVlA4WAoAAAAQAAAADwAABQAAQUxQSGEAAAAAAE6XuGgDBQQCAgQCAwIEAz2gdjLaoRYAAAAAAIBCAACYX8F8uGgvlR5EcEhmG3ZhmXnaa06YkaXa2N2Dj3SmupeYkgA5xrqfhK5&#43;vr7BtaA5y0IEBDAdOwAUEzApJzQcAFZQOCAwAAAA0AEAnQEqEAAGAAKYfCewAnQA9E5Di/AA/mQNGp8u5XkQdcb9yTf0qO05YY9qwAAA"
    data-src="/pionia_hu7bc625304583a71a69e31d56c05815e9_99619_480x0_resize_q85_bgffffff_lanczos_3.jpg"
    width="602"
    height="232"
    decoding="async"
    fetchpriority="auto"
    loading="lazy"
    alt="Pionia Logo"
    class="lazyload blur-up"
  >
</picture>
<div class="callout callout-tip d-flex flex-row mt-4 mb-4 pt-4 pe-4 pb-2 ps-3">
  
  <div class="callout-content">
    
    <div class="callout-body">
      <p>This guide assumes you have a basic understanding of how Pionia Security works. If you are new to Pionia, you can start by going through the <a href="/documentation/security-authentication-and-authorization/">API Tutorial</a> guide.</p>

    </div>
  </div>
</div>

<h2 id="our-target">Our target<a href="#our-target" class="anchor" aria-hidden="true">#</a> </h2>
<p>Our target is to create a simple authentication system using JWT. We will use the Firebase/JWT package to illustrate how to create a simple authentication system.</p>
<p>This authentication should be able to intercept every request and attempt to authenticate the user.</p>
<h2 id="installation">Installation<a href="#installation" class="anchor" aria-hidden="true">#</a> </h2>
<p>We need the Firebase/JWT package to create our authentication system. You can install the package via composer.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">composer require firebase/php-jwt</span></span></code></pre></div>
  </figure>
</div>
<h2 id="requirements">Requirements<a href="#requirements" class="anchor" aria-hidden="true">#</a> </h2>
<p>You should have a database table called <code>system_user</code> with the following columns:</p>



<div class="expressive-code">
  <figure class="frame has-title not-content">
  <figcaption class="header">
    <span class="title">Postgres ddl</span>
  </figcaption>
  <div class="highlight" title="Postgres ddl"><pre tabindex="0" class="chroma"><code class="language-postgresql" data-lang="postgresql"><span class="line"><span class="cl"><span class="k">create</span> <span class="k">table</span> <span class="n">public</span><span class="mf">.</span><span class="n">system_user</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_name</span>        <span class="nb">varchar</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_name</span>         <span class="nb">varchar</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">password</span>          <span class="nb">varchar</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">email</span>             <span class="nb">varchar</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span>          <span class="nb">varchar</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">role_code</span>         <span class="nb">varchar</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">created_at</span>        <span class="nb">timestamp</span> <span class="k">default</span> <span class="n">now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_logged_in_at</span> <span class="nb">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_active</span>         <span class="nb">boolean</span>   <span class="k">default</span> <span class="k">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">id</span>                <span class="nb">bigserial</span>
</span></span><span class="line"><span class="cl">        <span class="k">constraint</span> <span class="n">system_user_pk</span>
</span></span><span class="line"><span class="cl">            <span class="k">primary</span> <span class="k">key</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div>
  </figure>
</div>
<p>For this tutorial, we shall be using <code>PostgreSQL</code> as our database.</p>
<h2 id="bootstrapping-our-authentication-backend">Bootstrapping our Authentication Backend<a href="#bootstrapping-our-authentication-backend" class="anchor" aria-hidden="true">#</a> </h2>
<p>Pionia provides to Bootstrap our authentication backend using the Pionia CLI. You can run the following command to create the authentication backend.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">php pionia gen:auth jwt</span></span></code></pre></div>
  </figure>
</div>
<p>This will create the <code>authentications</code> folder if it doesn&rsquo;t exist and create the <code>jwt</code> authentication backend in the same folder.</p>
<p>After this, you should have the following files in your <code>authentications</code> directory:</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">app
</span></span><span class="line"><span class="cl">├──authentications/
</span></span><span class="line"><span class="cl">    ├── JwtAuthenticationBackend.php</span></span></code></pre></div>
  </figure>
</div>
<p>And the above class should look like this:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * This authentication backend is auto-generated from pionia cli.
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Remember to register your backend in index.php.
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">application\authentications</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Core\Helpers\ContextUserObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Core\Interceptions\BaseAuthenticationBackend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Request\Request</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">JwtAuthBackend</span> <span class="k">extends</span> <span class="nx">BaseAuthenticationBackend</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Implement this method and return your &#39;ContextUserObject&#39;. You can use Porm here too!
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="o">?</span><span class="nx">ContextUserObject</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$userObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ContextUserObject</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1"># your logic here...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nv">$userObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div>
  </figure>
</div>
<p>Let&rsquo;s first leave this file as it is and create a new file <code>JwtUtility.php</code> in the <code>utils</code> directory. We shall get back to it.</p>
<p>For separation of concerns, let&rsquo;s create a utils directory where we shall drop all utility classes for our app.</p>
<p>Create a new file <code>JwtUtility.php</code> in the same <code>utils</code> directory.</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">app
</span></span><span class="line"><span class="cl">├──utils/
</span></span><span class="line"><span class="cl">    ├── JwtUtility.php</span></span></code></pre></div>
  </figure>
</div>
<p>In the <code>JwtUtility.php</code> file, add the following code:</p>



<div class="expressive-code">
  <figure class="frame has-title not-content">
  <figcaption class="header">
    <span class="title">JwtUtility.php</span>
  </figcaption>
  <div class="highlight" title="JwtUtility.php"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">application\utils</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Firebase\JWT\JWT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Firebase\JWT\Key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Core\Pionia</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Exceptions\UserUnauthenticatedException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Porm\Database\builders\Where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Porm\Porm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="k">stdClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">JwtUtility</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * get the JWT settings from our settings.ini
</span></span></span><span class="line"><span class="cl"><span class="sd">     * */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">jwtSettings</span><span class="p">()</span> <span class="o">:</span> <span class="k">array</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">pionia</span><span class="o">::</span><span class="na">getSetting</span><span class="p">(</span><span class="s1">&#39;JWT&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * We grab a user from the database where either username or email is equivalent to the provided
</span></span></span><span class="line"><span class="cl"><span class="sd">     * If we don&#39;t want to return the password hash, we pass false as the second param
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getUserByUsername</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$username</span><span class="p">,</span> <span class="o">?</span><span class="nx">bool</span> <span class="nv">$withPassword</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span><span class="o">:</span> <span class="nx">object</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$columns</span> <span class="o">=</span> <span class="s2">&#34;*&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// we define all the columns we need to return except the password hash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$withPassword</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$columns</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;role_code&#34;</span><span class="p">,</span> <span class="s2">&#34;created_at&#34;</span><span class="p">,</span> <span class="s2">&#34;last_logged_in_at&#34;</span><span class="p">,</span> <span class="s2">&#34;is_active&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Porm</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s2">&#34;system_user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">columns</span><span class="p">(</span><span class="nv">$columns</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Where</span><span class="o">::</span><span class="na">builder</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">or</span><span class="p">([</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">UserUnauthenticatedException</span><span class="p">(</span><span class="s2">&#34;User not found&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">is_active</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">UserUnauthenticatedException</span><span class="p">(</span><span class="s2">&#34;User account is not active&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Generates the jwt token and updates the user&#39;s last login date
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateToken</span><span class="p">(</span><span class="nx">object</span> <span class="nv">$user</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$expiresAt</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jwtSettings</span><span class="p">()[</span><span class="s1">&#39;expires_at&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$secretKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jwtSettings</span><span class="p">()[</span><span class="s1">&#39;secret_key&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$iat</span> <span class="o">=</span> <span class="nx">time</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$eat</span><span class="o">=</span> <span class="nv">$iat</span> <span class="o">+</span> <span class="nv">$expiresAt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$payload</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;iss&#34;</span> <span class="o">=&gt;</span> <span class="nx">pionia</span><span class="o">::</span><span class="nv">$name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;iat&#34;</span> <span class="o">=&gt;</span> <span class="nv">$iat</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;exp&#34;</span> <span class="o">=&gt;</span> <span class="nv">$eat</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;sub&#34;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$token</span> <span class="o">=</span> <span class="nx">JWT</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$payload</span><span class="p">,</span> <span class="nv">$secretKey</span><span class="p">,</span> <span class="s1">&#39;HS256&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if we have our token, we populate the last login time for this user
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Porm</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s2">&#34;system_user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="s1">&#39;last_logged_in_at&#39;</span> <span class="o">=&gt;</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;m/d/Y H:i:s&#34;</span><span class="p">,</span> <span class="nv">$iat</span><span class="p">)],</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Decodes any jwt token using our secret_key with a leeway of only 60 seconds
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $token
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return stdClass
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">decodeToken</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$token</span><span class="p">)</span><span class="o">:</span> <span class="k">stdClass</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">jwtSettings</span><span class="p">()[</span><span class="s1">&#39;secret_key&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">JWT</span><span class="o">::</span><span class="nv">$leeway</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span> <span class="c1">// 60 secs -- to cater for clock skew times between the signing and verifying servers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">JWT</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$token</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Key</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="s1">&#39;HS256&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h3 id="what-do-we-have-here">What do we have here?<a href="#what-do-we-have-here" class="anchor" aria-hidden="true">#</a> </h3>
<p>We have a <code>JwtUtility</code> class that handles all our JWT logic.</p>
<ul>
<li>
<p><code>getUserByUsername</code> method fetches a user by username or email from the database. It also checks if the user is active. If the user is not found or not active, it throws an exception.
In normal circumstances, this method returns everything from the <code>system_user</code> table, including the password hash. However, if
<code>$withPassword</code> is set to <code>false</code>, it returns everything except the password hash. This is useful when you want to return the user object to the client.</p>
</li>
<li>
<p><code>jwtSettings</code> method returns the JWT settings from the <code>settings.ini</code> file.</p>
</li>
<li>
<p><code>generateToken</code> method generates a JWT token for the user. It fetches the user by username, generates a token, and updates the last login date in the database.</p>
</li>
<li>
<p><code>decodeToken</code> method decodes the token and returns the decoded token.</p>
</li>
</ul>
<p>We shall use this utility class in our <code>JwtAuthenticationBackend.php</code> file and in our login action.</p>
<p>In our <code>JwtAuthenticationBackend.php</code> in the authentications folder, replace the <code>authenticate</code> method with the following code:</p>



<div class="expressive-code">
  <figure class="frame has-title not-content">
  <figcaption class="header">
    <span class="title">JwtAuthenticationBackend.php</span>
  </figcaption>
  <div class="highlight" title="JwtAuthenticationBackend.php"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Gets the authorization header from the request and authenticates with the provided token
</span></span></span><span class="line"><span class="cl"><span class="sd">     * If everything is okay, the context user is returned and Pionia will take over from here.
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="o">?</span><span class="nx">ContextUserObject</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$authorizationHeader</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">headers</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s2">&#34;Authorization&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$authorizationHeader</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$jwtUtility</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JwtUtility</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$bearerKey</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">-&gt;</span><span class="na">jwtSettings</span><span class="p">()[</span><span class="s1">&#39;bearer_key&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="s1">&#39;Bearer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// check if our token starts with the above key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">str_starts_with</span><span class="p">(</span><span class="nv">$authorizationHeader</span><span class="p">,</span> <span class="nv">$bearerKey</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// grab the token alone removing the &#34;Bearer &#34; part
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$token</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nx">str_replace</span><span class="p">(</span><span class="nv">$bearerKey</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$authorizationHeader</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">-&gt;</span><span class="na">decodeToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$decoded</span><span class="o">-&gt;</span><span class="na">sub</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span>  <span class="nv">$jwtUtility</span><span class="o">::</span><span class="na">getUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// since we have our context user, we can populate them from here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$contextUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ContextUserObject</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">user</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">authenticated</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">authExtra</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">role_code</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// we have no permissions, so we ignore the permissions key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nv">$contextUser</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h3 id="what-do-we-have-here-1">What do we have here?<a href="#what-do-we-have-here-1" class="anchor" aria-hidden="true">#</a> </h3>
<ul>
<li>We get the Authorization header from the request.</li>
<li>We get the <code>bearer_key</code> from the <code>settings.ini</code> file. This is to make it easy to change the name of the Authorization header.</li>
<li>We check if the Authorization header is empty or does not start with the <code>bearer_key</code>. If it does not, we return <code>null</code> and the request will proceed but
unauthenticated.</li>
<li>Otherwise, we create a new <code>ContextUserObject</code> and decode the token. We then fetch the user by username and set the <code>authenticated</code> property to <code>true</code> and the <code>user</code> property to the user object we got from the database.</li>
<li>We return the <code>ContextUserObject</code>. This is what must be returned by the <code>authenticate</code> method.</li>
</ul>
<p>In our <code>settings.ini</code> file, add the following settings:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[JWT]</span>
</span></span><span class="line"><span class="cl"><span class="na">expires_at</span><span class="o">=</span><span class="s">3600</span>
</span></span><span class="line"><span class="cl"><span class="na">secret_key</span><span class="o">=</span><span class="s">yti87y2XMluYnUQQShUYApqmwkezWjzn</span>
</span></span><span class="line"><span class="cl"><span class="na">bearer_key</span><span class="o">=</span><span class="s">Bearer</span></span></span></code></pre></div>
  </figure>
</div>
<p>Still in the <code>settings.ini</code> file, let&rsquo;s register our Authentication Backend:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[authentications]</span>
</span></span><span class="line"><span class="cl"><span class="na">jwt</span><span class="o">=</span><span class="s">application\authentications\JwtAuthBackend</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="add-our-login-logic">Add our Login Logic<a href="#add-our-login-logic" class="anchor" aria-hidden="true">#</a> </h2>
<p>In our services directory, create a new file <code>UserService.php</code>. In normal circumstances, you should have the <code>UserService</code> class
already created for you. But if it&rsquo;s not, you can create it in two ways. You can either create it manually or use the Pionia CLI to generate it for you.</p>
<p>Using the Pionia CLI:</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">php pionia gen:service user</span></span></code></pre></div>
  </figure>
</div>
<ul>
<li>
<p>Select <code>Basic</code> in the options provided by entering <code>1</code> or just hitting <code>enter</code> since it&rsquo;s the default.</p>
</li>
<li>
<p>On the next action, you can write <code>register,login</code> to generate the <code>register</code> and <code>login</code> actions.</p>
</li>
</ul>
<blockquote>
<p>And you should have the new service created for you in the <code>services</code> directory.</p>
</blockquote>



<div class="expressive-code">
  <figure class="frame is-terminal has-title not-content">
  <figcaption class="header">
    <span class="title">UserService.php</span>
  </figcaption>
  <div class="highlight" title="UserService.php"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">services/
</span></span><span class="line"><span class="cl">├── UserService.php</span></span></code></pre></div>
  </figure>
</div>
<p><div class="callout callout-tip d-flex flex-row mt-4 mb-4 pt-4 pe-4 pb-2 ps-3">
  
  <div class="callout-content">
    
    <div class="callout-body">
      <p>However, I created mine manually, so what I have as <code>login</code> will be equivalent to your <code>loginUser</code> and <code>register</code> will be equivalent to your <code>registerUser</code>.</p>

    </div>
  </div>
</div>

And add the following code:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nx">application\services</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">application\authenticationBackends\JwtUtils</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Request\BaseRestService</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Response\BaseResponse</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Porm\Porm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserService</span> <span class="k">extends</span> <span class="nx">BaseRestService</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">:</span> <span class="nx">BaseResponse</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">requires</span><span class="p">([</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$jwtUtility</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JwtUtility</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">::</span><span class="na">getUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$checkPassword</span> <span class="o">=</span> <span class="nx">password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$checkPassword</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidDataException</span><span class="p">(</span><span class="s2">&#34;Wrong password&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">-&gt;</span><span class="na">generateToken</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BaseResponse</span><span class="o">::</span><span class="na">JsonResponse</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Logged in successfully&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;token&#39;</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $data
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return BaseResponse
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">:</span> <span class="nx">BaseResponse</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// user can&#39;t exceed here if any of these columns are provided
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// in the   request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">requires</span><span class="p">([</span><span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>  <span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$first_name</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;first_name&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$last_name</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;last_name&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;email&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;password&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;username&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// if the user does not define a role, we set it to USER.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// not cool for production
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$role_code</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s2">&#34;role_code&#34;</span><span class="p">]</span> <span class="o">??</span> <span class="s1">&#39;USER&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// data validation. User can&#39;t pass here if the following are invalid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">asEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">asPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$hash</span> <span class="o">=</span> <span class="nx">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// check if the email isn&#39;t taken
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$checkEmail</span> <span class="o">=</span> <span class="nx">Porm</span><span class="o">::</span><span class="na">from</span><span class="p">(</span><span class="s2">&#34;system_user&#34;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">([</span><span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$checkEmail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidDataException</span><span class="p">(</span><span class="s2">&#34;Email already exists&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// check if the username is taken
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$checkUsername</span> <span class="o">=</span> <span class="nx">Porm</span><span class="o">::</span><span class="na">from</span><span class="p">(</span><span class="s2">&#34;system_user&#34;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">([</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$checkUsername</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidDataException</span><span class="p">(</span><span class="s2">&#34;Username already exists&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$saved</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// saving happens in a transaction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">Porm</span><span class="o">::</span><span class="na">from</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">inTransaction</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">,</span> <span class="nv">$first_name</span><span class="p">,</span> <span class="nv">$last_name</span><span class="p">,</span> <span class="nv">$role_code</span><span class="p">,</span> <span class="nv">$username</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$saved</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$saved</span> <span class="o">=</span> <span class="nx">Porm</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s2">&#34;system_user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">-&gt;</span><span class="na">columns</span><span class="p">([</span><span class="s2">&#34;email&#34;</span><span class="p">,</span> <span class="s2">&#34;first_name&#34;</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span><span class="p">,</span> <span class="s2">&#34;role_code&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;is_active&#34;</span><span class="p">,</span> <span class="s2">&#34;last_logged_in_at&#34;</span><span class="p">,</span> <span class="s2">&#34;created_at&#34;</span><span class="p">])</span> <span class="c1">// we want to ignore the password field in data returned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">-&gt;</span><span class="na">save</span><span class="p">([</span><span class="s2">&#34;email&#34;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span> <span class="o">=&gt;</span> <span class="nv">$hash</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span> <span class="o">=&gt;</span> <span class="nv">$username</span><span class="p">,</span> <span class="s2">&#34;role_code&#34;</span> <span class="o">=&gt;</span> <span class="nv">$role_code</span><span class="p">,</span> <span class="s2">&#34;first_name&#34;</span> <span class="o">=&gt;</span> <span class="nv">$first_name</span><span class="p">,</span> <span class="s2">&#34;last_name&#34;</span> <span class="o">=&gt;</span> <span class="nv">$last_name</span><span class="p">,</span> <span class="s2">&#34;is_active&#34;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span> <span class="c1">// let&#39;s just activate all profiles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$saved</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidDataException</span><span class="p">(</span><span class="s2">&#34;Failed to create user&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BaseResponse</span><span class="o">::</span><span class="na">JsonResponse</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;User added successfully&#34;</span><span class="p">,</span> <span class="nv">$saved</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div>
  </figure>
</div>
<h3 id="what-do-we-have-here-2">What do we have here?<a href="#what-do-we-have-here-2" class="anchor" aria-hidden="true">#</a> </h3>
<ul>
<li>We have a <code>UserService</code> class that extends <code>BaseRestService</code>. This class has two actions: <code>login</code> and <code>register</code>.</li>
<li>In the <code>login</code> action, we require the <code>username</code> and <code>password</code> fields.
We then fetch the user by username and verify the password. If the password is correct, we generate a token and return it.</li>
<li>In the <code>register</code> action, we require the <code>username</code>, <code>password</code>, <code>email</code>, <code>first_name</code>, and <code>last_name</code> fields.</li>
<li>We set the <code>role_code</code> to <code>USER</code> if it&rsquo;s not provided.</li>
<li>We validate the email and password fields. <code>asEmail</code> checks if we have a valid email and <code>asPassword</code> checks if the password passes
the minimum requirements(at least 1 special character, at least 1 capital letter, at least 1 digit, length of at least 8).</li>
<li>We then hash the password and save the user to the database.</li>
<li>We check if the username and email are already taken.</li>
<li>If everything is okay, we create the user in transaction and return the user object.</li>
<li>We define the columns that should be returned upon successful creation of the user.</li>
<li>We return a JSON response with the user object.</li>
</ul>
<h3 id="registering-our-userservice">Registering our UserService<a href="#registering-our-userservice" class="anchor" aria-hidden="true">#</a> </h3>
<p>We shall also need to register our <code>UserService</code> in the switch which shall handle henceforth all our requests.</p>
<p>Create a switch if it doesn&rsquo;t exist in your <code>switches</code> directory. This can be created manually or using Pionia Cli</p>
<p>Using Pionia CLI</p>



<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">php pionia gen:switch v2</span></span></code></pre></div>
  </figure>
</div>
<p>You must target the version the switch is targeting, the above targets version 2 which can be accessed on <code>/api/v2/</code>.
The above command creates <code>V2Switch.php</code> in the <code>switches</code> directory.</p>
<p>You then have to register it in your <code>routes.php</code> file.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nx">Pionia\Core\Routing\PioniaRouter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PioniaRouter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$router</span><span class="o">-&gt;</span><span class="na">addSwitchFor</span><span class="p">(</span><span class="s2">&#34;application\switches\MainApiSwitch&#34;</span><span class="p">)</span> <span class="c1">// by default targets v1 -- /api/v1/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">-&gt;</span><span class="na">addSwitchFor</span><span class="p">(</span><span class="s2">&#34;application\switches\V2Switch&#34;</span><span class="p">,</span> <span class="s2">&#34;v2&#34;</span><span class="p">);</span> <span class="c1">// that&#39;s the version we are targeting -- /api/v2/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getRoutes</span><span class="p">();</span></span></span></code></pre></div>
  </figure>
</div>
<div class="callout callout-note d-flex flex-row mt-4 mb-4 pt-4 pe-4 pb-2 ps-3">
  
  <div class="callout-content">
    
    <div class="callout-body">
      <p>Under normal circumstances, the <code>MainApiSwitch.php</code> that ships with the template is enough!</p>

    </div>
  </div>
</div>




<div class="expressive-code">
  <figure class="frame is-terminal not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">switches/
</span></span><span class="line"><span class="cl">├── MainApiSwitch.php</span></span></code></pre></div>
  </figure>
</div>
<p>And add to your <code>registerServices</code> method in the <code>MainApiSwitch.php</code> file the following code:</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainApiSwitch</span> <span class="k">extends</span> <span class="nx">BaseApiServiceSwitch</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Register your services here.
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return array
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerServices</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;user&#39;</span> <span class="o">=&gt;</span> <span class="nx">UserService</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="c1">// notice this here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="testing-our-authentication">Testing our Authentication<a href="#testing-our-authentication" class="anchor" aria-hidden="true">#</a> </h2>
<p>To test our authentication, we shall use Postman. You can download Postman <a href="https://www.postman.com/downloads/">here</a>.</p>
<h3 id="registering-a-user">Registering a User<a href="#registering-a-user" class="anchor" aria-hidden="true">#</a> </h3>
<p>To register a user, send a <code>POST</code> request to <code>http://localhost:8000/api/v1/</code> with the following JSON payload:</p>
<p>

<img
  src="/images/user-registration_huf317fe2e1bc2d93ff61586342ae257fe_46462_1040x1032_resize_q85_h2_lanczos.webp"
  width="1040"
  height="1032"
  decoding="async"
  fetchpriority="auto"
  loading="lazy"
  alt="User Registration Request"id="h-rh-i-0"
/></p>
<h3 id="register-user---response">Register User - Response<a href="#register-user---response" class="anchor" aria-hidden="true">#</a> </h3>
<p>Making the above request, should return the following response.</p>
<p>

<img
  src="/images/user-registration-response_hu2ef660eb6ca82811973d45a106537cfe_49027_1080x943_resize_q85_h2_lanczos.webp"
  width="1080"
  height="943"
  decoding="async"
  fetchpriority="auto"
  loading="lazy"
  alt="User Registration Response"id="h-rh-i-1"
/></p>
<h3 id="logging-in-a-user">Logging in a User<a href="#logging-in-a-user" class="anchor" aria-hidden="true">#</a> </h3>
<p>To test Login, send a <code>POST</code> request to <code>http://localhost:8000/api/v1/</code> with the following JSON payload:</p>
<p>

<img
  src="/images/login-request_hu109581ef3ff7bbf76a1844309ed9bd5a_251422_2784x952_resize_q85_h2_lanczos_3.webp"
  width="2784"
  height="952"
  decoding="async"
  fetchpriority="auto"
  loading="lazy"
  alt="User Login Request"id="h-rh-i-2"
/></p>
<h3 id="login-user---response">Login User - Response<a href="#login-user---response" class="anchor" aria-hidden="true">#</a> </h3>
<p>You should get a response with a token like below.</p>
<p>

<img
  src="/images/login-response_hu927eababe2b926e436cbbcbfc485da54_406296_3608x1312_resize_q85_h2_lanczos_3.webp"
  width="3608"
  height="1312"
  decoding="async"
  fetchpriority="auto"
  loading="lazy"
  alt="User Login Response"id="h-rh-i-3"
/></p>
<p>You can use this token to authenticate your requests.</p>
<h3 id="testing-authentication">Testing Authentication<a href="#testing-authentication" class="anchor" aria-hidden="true">#</a> </h3>
<p>So to test out that our authentication is working, we shall add another action called <code>profile</code> in our <code>UserService.php</code> file.</p>



<div class="expressive-code">
  <figure class="frame has-title not-content">
  <figcaption class="header">
    <span class="title">UserService.php</span>
  </figcaption>
  <div class="highlight" title="UserService.php"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @throws UserUnauthenticatedException
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">profile</span><span class="p">()</span><span class="o">:</span> <span class="nx">BaseResponse</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mustAuthenticate</span><span class="p">();</span> <span class="c1">// user can&#39;t pass here if they are not authenticated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">auth</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BaseResponse</span><span class="o">::</span><span class="na">JsonResponse</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h3 id="testing-the-profile-action---request-without-token">Testing the Profile Action - request without token<a href="#testing-the-profile-action---request-without-token" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;POST&#34;</span> <span class="err">http:</span><span class="c1">//localhost:8000/api/v1/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;profile&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h3 id="response---not-token">Response - not token<a href="#response---not-token" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnCode&#34;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnMessage&#34;</span><span class="p">:</span> <span class="s2">&#34;You must be authenticated to access this resource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnData&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;extraData&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>Now let&rsquo;s test the profile action with a token.</p>
<h3 id="testing-the-profile-action---request-with-token">Testing the Profile Action - request with token<a href="#testing-the-profile-action---request-with-token" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">POST</span> <span class="err">/api/v</span><span class="mi">1</span><span class="err">/</span> <span class="err">HTTP/</span><span class="mf">1.1</span>
</span></span><span class="line"><span class="cl"><span class="err">Host:</span> <span class="err">localhost:</span><span class="mi">8000</span>
</span></span><span class="line"><span class="cl"><span class="err">Content-Type:</span> <span class="err">application/json</span>
</span></span><span class="line"><span class="cl"><span class="err">Authorization:</span> <span class="err">Bearer</span> <span class="err">eyJ</span><span class="mi">0</span><span class="err">eXAiOiJKV</span><span class="mi">1</span><span class="err">QiLCJhbGciOiJIUzI</span><span class="mi">1</span><span class="err">NiJ</span><span class="mi">9</span><span class="err">.eyJpc</span><span class="mi">3</span><span class="err">MiOiJQaW</span><span class="mi">9</span><span class="err">uaWEiLCJpYXQiOjE</span><span class="mi">3</span><span class="err">MjIyNTQ</span><span class="mi">3</span><span class="err">MjIsImV</span><span class="mi">4</span><span class="err">cCI</span><span class="mi">6</span><span class="err">MTcyMjI</span><span class="mi">1</span><span class="err">ODMyMiwic</span><span class="mi">3</span><span class="err">ViIjoiamV</span><span class="mi">0</span><span class="err">MSJ</span><span class="mf">9.8</span><span class="err">gzQNbPR</span><span class="mi">74</span><span class="err">RqAFa</span><span class="mi">6</span><span class="err">HxFhFGMv</span><span class="mi">904</span><span class="err">ow</span><span class="mi">2</span><span class="err">Ux</span><span class="mi">5</span><span class="err">Eq_yKRcVz</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="err">Content-Length:</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;profile&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h3 id="testing-the-profile-action---request-with-token-1">Testing the Profile Action - request with token<a href="#testing-the-profile-action---request-with-token-1" class="anchor" aria-hidden="true">#</a> </h3>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnCode&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnMessage&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;returnData&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;first_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Test&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;last_name&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;$2y$10$obbGcRTCDgV31K5k2KMW8.8hkXy6Enh3K9l9JHRpgsTmfwlXVgScy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;sample1@gmail.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;jet1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;role_code&#34;</span><span class="p">:</span> <span class="s2">&#34;USER&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;created_at&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-29 10:00:39.671637&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;last_logged_in_at&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-29 12:05:22&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;is_active&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;extraData&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<p>We can remove the above password hash just to clean up further.</p>
<p>In our authentication backend, let&rsquo;s change the following line highlighted and add <code>false</code> as the second parameter to the <code>getUserByUsername</code> method.</p>



<div class="expressive-code">
  <figure class="frame not-content">
  <figcaption class="header">
    <span class="title"></span>
  </figcaption>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="o">?</span><span class="nx">ContextUserObject</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="nv">$authorizationHeader</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">headers</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s2">&#34;Authorization&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$authorizationHeader</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="nv">$jwtUtility</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JwtUtility</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="nv">$bearerKey</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">-&gt;</span><span class="na">jwtSettings</span><span class="p">()[</span><span class="s1">&#39;bearer_key&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="s1">&#39;Bearer&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="c1">// check if our token starts with the above key
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">str_starts_with</span><span class="p">(</span><span class="nv">$authorizationHeader</span><span class="p">,</span> <span class="nv">$bearerKey</span><span class="p">)){</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="c1">// grab the token alone removing the &#34;Bearer &#34; part
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="c1"></span>        <span class="nv">$token</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nx">str_replace</span><span class="p">(</span><span class="nv">$bearerKey</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$authorizationHeader</span><span class="p">));</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nv">$jwtUtility</span><span class="o">-&gt;</span><span class="na">decodeToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$decoded</span><span class="o">-&gt;</span><span class="na">sub</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">
</span></span><span class="line hl"><span class="ln">45</span><span class="cl">        <span class="nv">$user</span> <span class="o">=</span>  <span class="nv">$jwtUtility</span><span class="o">::</span><span class="na">getUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">        <span class="c1">// since we have our context user, we can populate them from here
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="c1"></span>        <span class="nv">$contextUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ContextUserObject</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">user</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">authenticated</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">        <span class="nv">$contextUser</span><span class="o">-&gt;</span><span class="na">authExtra</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">role_code</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="c1">// we have no permissions, so we ignore the permissions key
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nv">$contextUser</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">	<span class="p">}</span></span></span></code></pre></div>
  </figure>
</div>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor" aria-hidden="true">#</a> </h2>
<p>This is a simple way to create an authentication system using JWT in Pionia. You can extend this to include more features like password reset, email verification, etc. You can also use other JWT libraries like <code>lcobucci/jwt</code> or <code>spomky-labs/jose</code> if you prefer.</p>
<div class="callout callout-tip d-flex flex-row mt-4 mb-4 pt-4 pe-4 pb-2 ps-3">
  
  <div class="callout-content">
    
    <div class="callout-body">
      <p>Remember to always hash your passwords before saving them to the database. You can use the <code>password_hash</code> function in PHP.</p>

    </div>
  </div>
</div>


			<div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between">
				
				


  













<div class="edit-page">
  <a href="https://github.com/PioniaPHP-project/pionia-docs/blob/main/content//docs/documentation/800_jwt_authentication.md">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2">
      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
    </svg>
    Edit this page on GitHub
  </a>
</div>

				</div>
			<div class="page-nav d-flex flex-column flex-sm-row">
	
	<div class="card w-100">
			<div class="card-body d-flex">
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M5 12l6 6"></path>
						<path d="M5 12l6 -6"></path>
				 	</svg>
				</div>
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Prev</div>
					<a href="/documentation/security-authentication-and-authorization/" class="stretched-link text-reset text-decoration-none">Security - Authentication and Authorization</a>
				</div>
			</div>
		</div>
	<div class="m-2"></div>
	<div class="card text-end w-100">
			<div class="card-body d-flex justify-content-end">
				<div class="d-flex flex-column">
					<div class="text-body-secondary">Next</div>
					<a href="/documentation/database/configuration-getting-started/" class="stretched-link text-reset text-decoration-none">Configuration - Getting Started</a>
				</div>
				<div class="d-flex flex-column justify-content-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
						<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
						<path d="M5 12l14 0"></path>
						<path d="M13 18l6 -6"></path>
						<path d="M13 6l6 6"></path>
					</svg>
				</div>
			</div>
		</div>
	</div>

			
		</main>
		
	</div>

      
      </div>
    </div>
    
    
    <footer class="footer text-muted">
  <div class="container-sm">
    <div class="row">
      <div class="col-lg-8 text-center text-lg-start">
        <ul class="list-inline">
          <li class="list-inline-item"><a class="text-muted" href="/privacy/">Privacy Policy</a></li>
        </ul>
      </div>
      <div class="col-lg-8 text-center text-lg-end">
        <ul class="list-inline">
          <li class="list-inline-item">Brought to you by <a class="text-muted" href="https://servicecops.com/">Service Cops</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    

<script async
  src="/js/app.fee9f8ec7475f74b15d2b2c76604e00670c577ef11ab1b2c92344ab979b9ace4.js"
  integrity="sha256-/un47HR190sV0rLHZgTgBnDFd&#43;8RqxsskjRKuXm5rOQ=">
</script>





<script async
  src="/js/flexsearch.f41f5ca0007df2c47e9e7872158f93feda934e4cc9dbcbc02e471503b49d8087.js"
  integrity="sha256-9B9coAB98sR&#43;nnhyFY&#43;T/tqTTkzJ28vALkcVA7SdgIc=">
</script>
<script async
  src="/js/search-modal.bbdea845b287fc7f22a081c11a25b5bbfa96e74e43b36be5733f16439caf46be.js"
  integrity="sha256-u96oRbKH/H8ioIHBGiW1u/qW505Ds2vlcz8WQ5yvRr4=">
</script>

    <div class="d-inline-flex fixed-bottom-right pb-4 pe-4">
  <button id="toTop" type="button" class="btn btn-primary rounded-circle ms-auto p-2"><span class="visually-hidden">Top</span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6 15l6 -6l6 6"></path></svg></button>
</div>

    
  </body>
</html>